const API_BASE = '/api';

async function api<T>(path: string, options: RequestInit = {}): Promise<T> {
  const res = await fetch(`${API_BASE}${path}`, {
    headers: {
      Accept: "application/json",
      ...(options.headers || {}),
    },
    ...options,
  });

  if (!res.ok) {
    throw new Error(`${res.status} ${res.statusText}`);
  }

  return res.json();
}

export interface Health {
  status: string;
  version: string;
  ollama: string;
  mcp: string;
  forgejo: string;
  database: {
    status: string;
    documents: number;
  };
  models: Record<string, any>;
}

export interface ModelsStatus {
  status: string;
  available_models: string[];
  configured_models: string[];
  missing_models: string[];
}

export interface DocumentStats {
  total_documents: number;
  total_chunks: number;
}

export interface DocumentItem {
  id: number;
  filename: string;
  uploaded_at: string;
  metadata: Record<string, any>;
}

export interface TaskItem {
  id: number;
  name: string;
  status: string;
  created_at: string;
  updated_at?: string;
}

export interface PipelineResponse {
  code?: string;
  generated_code?: string;
  output_code?: string;
  result?: any;
  status?: string;
  [key: string]: any;
}

export const getHealth = () => api<Health>("/health");

export const getModelsStatus = () => api<ModelsStatus>("/models/status");

export const getDocumentStats = () => api<DocumentStats>("/documents/stats");

export const listDocuments = async (): Promise<DocumentItem[]> => {
  const res = await api<{ items: DocumentItem[] }>("/documents");
  return res.items || [];
};

export const queryDocuments = async (query: string, limit = 5): Promise<DocumentItem[]> => {
  const res = await api<{ items: DocumentItem[] }>(`/documents?q=${encodeURIComponent(query)}&limit=${limit}`);
  return res.items || [];
};

export const uploadDocument = async (file: File, metadata: Record<string, any>) => {
  const form = new FormData();
  form.append("file", file);
  form.append("metadata", JSON.stringify(metadata));
  const res = await fetch(`${API_BASE}/documents/upload`, {
    method: "POST",
    body: form,
  });
  if (!res.ok) {
    throw new Error("Upload failed");
  }
  return res.json();
};

export const listTasks = async (): Promise<TaskItem[]> => {
  const res = await api<{ items: TaskItem[] }>("/tasks");
  return res.items || [];
};

export const runPipeline = (payload: any): Promise<PipelineResponse> =>
  api<PipelineResponse>("/pipeline/run", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(payload),
  });
