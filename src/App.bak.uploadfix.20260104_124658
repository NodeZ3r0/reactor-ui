import { useState, useEffect, useRef, useMemo } from 'react';
import MonacoEditor from '@monaco-editor/react';
import {
  getHealth,
  getModelsStatus,
  listTasks,
  listDocuments,
  uploadDocument,
  queryDocuments,
  runPipeline,
  type DocumentItem,
  type Health,
  type ModelsStatus,
  type TaskItem,
} from "./api";

type View = "dashboard" | "pipeline" | "rag";
type RepoProvider = "forgejo" | "github" | "gitlab" | "codeberg" | "custom";

type ReactorProject = {
  id: string;
  name: string;
  provider: RepoProvider;
  repo: string;
  repoUrl: string;
  createdAt: string;
  lastRunAt?: string;
};

const LS_PROJECTS = "reactor.projects.v1";
const LS_ACTIVE_PROJECT = "reactor.activeProjectId.v1";

function nowIso() {
  return new Date().toISOString();
}

function uid() {
  return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 10)}`;
}

function safeJsonParse<T>(raw: string | null, fallback: T): T {
  try {
    if (!raw) return fallback;
    return JSON.parse(raw) as T;
  } catch {
    return fallback;
  }
}

function normalizeRepoUrl(provider: RepoProvider, repo: string, repoUrl: string) {
  const r = (repo || "").trim();
  const u = (repoUrl || "").trim();
  if (provider === "forgejo") {
    return { repo: r, repoUrl: "" };
  }
  if (provider === "custom") {
    return { repo: r, repoUrl: u };
  }
  if (u) return { repo: r, repoUrl: u };
  if (r.startsWith("http://") || r.startsWith("https://")) return { repo: "", repoUrl: r };
  if (r.includes("/")) {
    const base =
      provider === "github" ? "https://github.com/"
      : provider === "gitlab" ? "https://gitlab.com/"
      : provider === "codeberg" ? "https://codeberg.org/"
      : "";
    if (base) return { repo: r, repoUrl: base + r };
  }
  return { repo: r, repoUrl: u };
}

function repoDisplay(p: ReactorProject) {
  if (p.provider === "forgejo") return p.repo || "(repo not set)";
  return p.repoUrl || p.repo || "(repo not set)";
}

function repoLink(p: ReactorProject) {
  if (p.provider === "forgejo") {
    const FORGEJO_PUBLIC_BASE = "https://vault.wopr.systems/";
    const r = (p.repo || "").trim().replace(/^\//, "");
    return r ? FORGEJO_PUBLIC_BASE + r : "";
  }
  return (p.repoUrl || "").trim();
}

function formatAgo(iso?: string) {
  if (!iso) return "—";
  const t = Date.parse(iso);
  if (!Number.isFinite(t)) return "—";
  const ms = Date.now() - t;
  const s = Math.floor(ms / 1000);
  if (s < 60) return `${s}s ago`;
  const m = Math.floor(s / 60);
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60);
  if (h < 24) return `${h}h ago`;
  const d = Math.floor(h / 24);
  return `${d}d ago`;
}

function pillClass(ok: boolean | null) {
  return ok === null ? "" : ok ? "ok" : "bad";
}

function Button(props: React.ButtonHTMLAttributes<HTMLButtonElement> & { variant?: "primary" | "ghost" }) {
  const { variant = "primary", className, ...rest } = props;
  return (
    <button
      {...rest}
      className={[
        "btn",
        variant === "primary" ? "btn-primary" : "btn-ghost",
        className || "",
      ].join(" ")}
    />
  );
}

function TextInput(props: React.InputHTMLAttributes<HTMLInputElement>) {
  const { className, ...rest } = props;
  return <input {...rest} className={["input", className || ""].join(" ")} />;
}

function Select(props: React.SelectHTMLAttributes<HTMLSelectElement>) {
  const { className, ...rest } = props;
  return <select {...rest} className={["select", className || ""].join(" ")} />;
}

function Panel(props: { title: string; children: React.ReactNode; right?: React.ReactNode }) {
  return (
    <div className="panel">
      <div className="panel-header">
        <div className="panel-title">{props.title}</div>
        <div className="panel-right">{props.right}</div>
      </div>
      <div className="panel-body">{props.children}</div>
    </div>
  );
}

function Divider() {
  return <div className="divider" />;
}

// ----------------------------------------------------------------------------
// VIEWS
// ----------------------------------------------------------------------------

function DashboardView(props: {
  health: Health | null;
  modelsStatus: ModelsStatus | null;
  tasks: TaskItem[];
  onRefreshHealth: () => void;
  onRefreshModels: () => void;
  onRefreshTasks: () => void;
}) {
  return (
    <div className="main-panels">
      <Panel
        title="System Status"
        right={
          <div className="panel-actions">
            <Button onClick={props.onRefreshHealth}>Refresh Health</Button>
            <Button onClick={props.onRefreshModels} variant="ghost">
              Refresh Models
            </Button>
          </div>
        }
      >
        <div className="kv">
          <div className="kv-row">
            <div className="kv-k">API</div>
            <div className="kv-v">{"/api"}</div>
          </div>
          <div className="kv-row">
            <div className="kv-k">Ollama</div>
            <div className="kv-v">{props.health?.ollama || "unknown"}</div>
          </div>
          <div className="kv-row">
            <div className="kv-k">DB</div>
            <div className="kv-v">{props.health?.database?.status || "unknown"} (docs: {props.health?.database?.documents ?? "?"})</div>
          </div>
          <div className="kv-row">
            <div className="kv-k">Forgejo</div>
            <div className="kv-v">{props.health?.forgejo || "unknown"}</div>
          </div>
          <div className="kv-row">
            <div className="kv-k">MCP</div>
            <div className="kv-v">{props.health?.mcp || "unknown"}</div>
          </div>
          <div className="kv-row">
            <div className="kv-k">RAG</div>
            <div className="kv-v">{props.health?.database?.status === "online" ? "online" : "offline"}</div>
          </div>
          <div className="kv-row">
            <div className="kv-k">Spec Kit</div>
            <div className="kv-v">{props.health?.status === "healthy" ? "online" : "offline"}</div>
          </div>
        </div>
        <Divider />
        <div className="subsection-title">Configured Models</div>
        <div className="chip-list">
          {(props.modelsStatus?.configured_models || []).length ? (
            (props.modelsStatus?.configured_models || []).map((m: string) => (
              <span key={m} className="chip">
                {m}
              </span>
            ))
          ) : (
            <span className="muted">No models list returned by API (endpoint may be unavailable).</span>
          )}
        </div>
      </Panel>
      <Panel
        title="Recent Runs / Tasks"
        right={
          <div className="panel-actions">
            <Button onClick={props.onRefreshTasks}>Refresh</Button>
          </div>
        }
      >
        {props.tasks?.length ? (
          <div className="table">
            <div className="table-head">
              <div>ID</div>
              <div>Status</div>
              <div>Created</div>
              <div>Updated</div>
            </div>
            {props.tasks.slice(0, 50).map((t, idx) => (
              <div className="table-row" key={(t.id as any) ?? idx}>
                <div className="mono">{t.id ?? "—"}</div>
                <div>{t.status ?? "—"}</div>
                <div className="mono">{t.created_at ?? "—"}</div>
                <div className="mono">{t.updated_at ?? "—"}</div>
              </div>
            ))}
          </div>
        ) : (
          <div className="muted">No tasks returned (endpoint may be unavailable).</div>
        )}
      </Panel>
    </div>
  );
}

function RagView(props: {
  activeProject: ReactorProject | null;
}) {
  const [docs, setDocs] = useState<DocumentItem[]>([]);
  const [docsLoading, setDocsLoading] = useState(false);
  const [q, setQ] = useState("");
  const [qLoading, setQLoading] = useState(false);
  const [qResult, setQResult] = useState<any>(null);
  const fileRef = useRef<HTMLInputElement | null>(null);

  // --- CHECKPOINT 1: Upload State & Duplicate Handling ---
  const [uploading, setUploading] = useState(false);
  const [duplicateFile, setDuplicateFile] = useState<{file: File, metadata: any} | null>(null);

  async function refreshDocs() {
    setDocsLoading(true);
    try {
      const items = await listDocuments();
      setDocs(items);
    } finally {
      setDocsLoading(false);
    }
  }

  useEffect(() => {
    refreshDocs();
  }, []);

  async function performUpload(file: File, metadata: any, overwrite: boolean) {
    setUploading(true);
    try {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("metadata", JSON.stringify(metadata));
      
      const res = await fetch(`/documents/upload?overwrite=${overwrite}`, {
        method: "POST",
        body: formData,
      });

      if (res.status === 409) {
        setDuplicateFile({ file, metadata });
        setUploading(false);
        return;
      }

      if (!res.ok) {
        throw new Error(`Upload failed: ${res.status} ${res.statusText}`);
      }

      if (fileRef.current) fileRef.current.value = "";
      setDuplicateFile(null);
      await refreshDocs(); 

    } catch (e: any) {
      alert("Error uploading: " + e.message);
    } finally {
      setUploading(false);
    }
  }

  async function onUpload() {
    const f = fileRef.current?.files?.[0];
    if (!f) return;
    const p = props.activeProject;
    const metadata = {
      source: "reactor",
      project: p?.name || "",
      provider: p?.provider || "",
      repo: p?.repo || "",
      repo_url: p?.repoUrl || "",
      uploaded_from: "reactor-ui",
      uploaded_at: nowIso(),
    };
    await performUpload(f, metadata, false);
  }

  async function onQuery() {
    const query = q.trim();
    if (!query) return;
    setQLoading(true);
    setQResult(null);
    try {
      const data = await queryDocuments(query, 6);
      setQResult(data);
    } finally {
      setQLoading(false);
    }
  }

  return (
    <div className="main-panels single">
      <Panel
        title="RAG / Documents"
        right={
          <div className="panel-actions">
            <Button onClick={refreshDocs} disabled={docsLoading}>
              {docsLoading ? "Refreshing..." : "Refresh"}
            </Button>
          </div>
        }
      >
        <div className="grid2">
          <div>
            <div className="subsection-title">Upload document</div>
            <div className="row">
              <input ref={fileRef} type="file" className="file" />
              <Button onClick={onUpload} disabled={uploading}>
                {uploading ? "Uploading..." : "Upload"}
              </Button>
            </div>
            <div className="muted" style={{ marginTop: 6 }}>
              Upload metadata is auto-attached from the active Project (Section A).
            </div>
            <Divider />
            <div className="subsection-title">Query</div>
            <div className="row">
              <TextInput
                placeholder="Ask the corpus…"
                value={q}
                onChange={(e) => setQ(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === "Enter") onQuery();
                }}
              />
              <Button onClick={onQuery} disabled={qLoading}>
                {qLoading ? "Querying..." : "Query"}
              </Button>
            </div>
            {qResult && (
              <pre className="pre">{JSON.stringify(qResult, null, 2)}</pre>
            )}
          </div>
          <div>
            <div className="subsection-title">Saved Documents</div>
            {docs?.length ? (
              <div className="table">
                <div className="table-head">
                  <div>ID</div>
                  <div>Filename</div>
                  <div>Uploaded</div>
                </div>
                {docs.slice(0, 200).map((d) => (
                  <div className="table-row" key={d.id}>
                    <div className="mono">{d.id}</div>
                    <div className="mono">{d.filename}</div>
                    <div className="mono">{formatAgo(d.uploaded_at)}</div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="muted">No documents yet.</div>
            )}
          </div>
        </div>

        {/* --- CHECKPOINT 1: Duplicate Overwrite Modal --- */}
        {duplicateFile && (
          <div className="modal-overlay">
            <div className="modal">
              <div className="modal-title" style={{ color: '#ffaa00' }}>Duplicate Document</div>
              <div className="form">
                <p>The file <span className="mono">{duplicateFile.file.name}</span> already exists.</p>
                <p>Do you want to overwrite it?</p>
                <div className="modal-actions">
                  <Button onClick={() => setDuplicateFile(null)} variant="ghost">Cancel</Button>
                  <Button onClick={() => performUpload(duplicateFile.file, duplicateFile.metadata, true)}>
                    Overwrite
                  </Button>
                </div>
              </div>
            </div>
          </div>
        )}

      </Panel>
    </div>
  );
}

function PipelineView(props: {
  projects: ReactorProject[];
  activeProjectId: string | null;
  setActiveProjectId: (id: string) => void;
  upsertProject: (p: ReactorProject) => void;
  updateProject: (id: string, patch: Partial<ReactorProject>) => void;
}) {
  const activeProject = useMemo(
    () => props.projects.find((p) => p.id === props.activeProjectId) || null,
    [props.projects, props.activeProjectId]
  );
  const [goal, setGoal] = useState("");
  const [phaseLog, setPhaseLog] = useState<string>("");
  const [running, setRunning] = useState(false);
  const [newOpen, setNewOpen] = useState(false);
  const [newName, setNewName] = useState("");
  const [newProvider, setNewProvider] = useState<RepoProvider>("forgejo");
  const [newRepo, setNewRepo] = useState("");
  const [newRepoUrl, setNewRepoUrl] = useState("");
  const [code, setCode] = useState<string>(
    `// Reactor Editor\n// Use pipeline run output and refine here.\n`
  );

  function openNewProject() {
    setNewName("");
    setNewProvider("forgejo");
    setNewRepo("");
    setNewRepoUrl("");
    setNewOpen(true);
  }

  function createProject() {
    const name = newName.trim();
    if (!name) return;
    const norm = normalizeRepoUrl(newProvider, newRepo, newRepoUrl);
    const p: ReactorProject = {
      id: uid(),
      name,
      provider: newProvider,
      repo: norm.repo,
      repoUrl: norm.repoUrl,
      createdAt: nowIso(),
    };
    props.upsertProject(p);
    props.setActiveProjectId(p.id);
    setNewOpen(false);
  }

  async function onRunPipeline() {
    const g = goal.trim();
    if (!g) return;
    if (!activeProject) {
      setPhaseLog("ERROR: No active Project selected.\nCreate/select a project first.\n");
      return;
    }
    setRunning(true);
    setPhaseLog("");
    try {
      const norm = normalizeRepoUrl(activeProject.provider, activeProject.repo, activeProject.repoUrl);
      const payload: any = {
        goal: g,
        project: activeProject.name,
        provider: activeProject.provider,
      };
      
      if (activeProject.provider === "forgejo") {
        payload.repo = norm.repo;
      } else {
        payload.repo_url = norm.repoUrl || "";
        payload.repo = norm.repo || "";
      }
      
      const res = await runPipeline(payload);
      props.updateProject(activeProject.id, { lastRunAt: nowIso() });
      const out = typeof res === "string" ? res : JSON.stringify(res, null, 2);
      setPhaseLog(out);
      
      if (res && typeof res === "object") {
        const codeCandidate =
          (res.code as string) ||
          (res.generated_code as string) ||
          (res.output_code as string) ||
          "";
        if (codeCandidate) setCode(codeCandidate);
      }
    } catch (e: any) {
      const msg =
        e?.response?.data
          ? JSON.stringify(e.response.data, null, 2)
          : e?.message || String(e);
      setPhaseLog(`ERROR:\n${msg}\n`);
    } finally {
      setRunning(false);
    }
  }

  const recentProjects = useMemo(() => {
    return [...props.projects].sort((a, b) => {
      const ta = Date.parse(a.lastRunAt || a.createdAt);
      const tb = Date.parse(b.lastRunAt || b.createdAt);
      return tb - ta;
    });
  }, [props.projects]);

  const link = activeProject ? repoLink(activeProject) : "";
  const nonForgejo = activeProject && activeProject.provider !== "forgejo";

  return (
    <div className="main-panels single">
      <Panel
        title="Pipeline & Editor"
        right={
          <div className="panel-actions">
            <Button onClick={openNewProject} variant="ghost">
              + New Project
            </Button>
          </div>
        }
      >
        <div className="subsection-title">Section A — Project</div>
        <div className="project-bar">
          <div className="project-select">
            <Select
              value={props.activeProjectId || ""}
              onChange={(e) => props.setActiveProjectId(e.target.value)}
            >
              <option value="" disabled>
                Select project…
              </option>
              {recentProjects.map((p) => (
                <option key={p.id} value={p.id}>
                  {p.name} · {p.provider}
                </option>
              ))}
            </Select>
            {activeProject && (
              <div className="project-meta">
                <div className="muted small">
                  Repo: <span className="mono">{repoDisplay(activeProject)}</span>
                </div>
                <div className="muted small">
                  Last run: <span className="mono">{formatAgo(activeProject.lastRunAt)}</span>
                </div>
              </div>
            )}
          </div>
          <div className="project-actions">
            {activeProject && link && (
              <a className="btn btn-ghost" href={link} target="_blank" rel="noreferrer">
                Open Repo
              </a>
            )}
          </div>
        </div>
        {nonForgejo && (
          <div className="warn">
            External repo selected ({activeProject?.provider}). If Spec Kit only pulls from Forgejo right now,
            the run may fail until Spec Kit supports repo_url cloning for that provider.
          </div>
        )}
        <Divider />
        <div className="subsection-title">Run Pipeline</div>
        <div className="row">
          <TextInput
            placeholder="Goal (what do we build/change?)"
            value={goal}
            onChange={(e) => setGoal(e.target.value)}
          />
          <Button onClick={onRunPipeline} disabled={running}>
            {running ? "Running..." : "Run Pipeline"}
          </Button>
        </div>
        <div className="grid2" style={{ marginTop: 10 }}>
          <div className="panel-sub">
            <div className="panel-sub-title">Editor</div>
            <div className="editor-wrap">
              <MonacoEditor
                height="420px"
                defaultLanguage="typescript"
                value={code}
                onChange={(v) => setCode(v || "")}
                options={{
                  minimap: { enabled: false },
                  fontSize: 13,
                  wordWrap: "on",
                  automaticLayout: true,
                }}
              />
            </div>
          </div>
          <div className="panel-sub">
            <div className="panel-sub-title">Run Output</div>
            <pre className="pre">{phaseLog || (running ? "Running…" : "No output yet.")}</pre>
          </div>
        </div>
        {newOpen && (
          <div className="modal-overlay" onMouseDown={() => setNewOpen(false)}>
            <div className="modal" onMouseDown={(e) => e.stopPropagation()}>
              <div className="modal-title">New Project</div>
              <div className="form">
                <label className="label">
                  Name
                  <TextInput value={newName} onChange={(e) => setNewName(e.target.value)} />
                </label>
                <label className="label">
                  Repo provider
                  <Select
                    value={newProvider}
                    onChange={(e) => setNewProvider(e.target.value as RepoProvider)}
                  >
                    <option value="forgejo">forgejo</option>
                    <option value="github">github</option>
                    <option value="gitlab">gitlab</option>
                    <option value="codeberg">codeberg</option>
                    <option value="custom">custom</option>
                  </Select>
                </label>
                <label className="label">
                  Repo (Forgejo: owner/repo OR repo; Others: owner/repo optional)
                  <TextInput value={newRepo} onChange={(e) => setNewRepo(e.target.value)} />
                </label>
                {newProvider !== "forgejo" && (
                  <label className="label">
                    Repo URL (https://…)
                    <TextInput value={newRepoUrl} onChange={(e) => setNewRepoUrl(e.target.value)} />
                  </label>
                )}
                <div className="modal-actions">
                  <Button onClick={() => setNewOpen(false)} variant="ghost">
                    Cancel
                  </Button>
                  <Button onClick={createProject}>Create</Button>
                </div>
              </div>
            </div>
          </div>
        )}
        <Divider />
        <div className="subsection-title">Previously Run Projects</div>
        {recentProjects.length ? (
          <div className="table">
            <div className="table-head">
              <div>Name</div>
              <div>Provider</div>
              <div>Repo</div>
              <div>Last Run</div>
            </div>
            {recentProjects.slice(0, 100).map((p) => (
              <div className="table-row" key={p.id}>
                <div className="mono">{p.name}</div>
                <div>{p.provider}</div>
                <div className="mono">{repoDisplay(p)}</div>
                <div className="mono">{formatAgo(p.lastRunAt)}</div>
              </div>
            ))}
          </div>
        ) : (
          <div className="muted">No projects yet. Create one above.</div>
        )}
      </Panel>
    </div>
  );
}

export default function App() {
  const [activeView, setActiveView] = useState<View>("dashboard");
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [health, setHealth] = useState<Health | null>(null);
  const [healthLoading, setHealthLoading] = useState(false);
  const [modelsStatus, setModelsStatus] = useState<ModelsStatus | null>(null);
  const [modelsLoading, setModelsLoading] = useState(false);
  const [tasks, setTasks] = useState<TaskItem[]>([]);
  const [tasksLoading, setTasksLoading] = useState(false);
  const [projects, setProjects] = useState<ReactorProject[]>(() =>
    safeJsonParse<ReactorProject[]>(localStorage.getItem(LS_PROJECTS), [])
  );
  const [activeProjectId, setActiveProjectId] = useState<string | null>(() =>
    localStorage.getItem(LS_ACTIVE_PROJECT) || null
  );

  useEffect(() => {
    localStorage.setItem(LS_PROJECTS, JSON.stringify(projects));
  }, [projects]);
  useEffect(() => {
    if (activeProjectId) localStorage.setItem(LS_ACTIVE_PROJECT, activeProjectId);
  }, [activeProjectId]);

  const activeProject = useMemo(
    () => projects.find((p) => p.id === activeProjectId) || null,
    [projects, activeProjectId]
  );

  function upsertProject(p: ReactorProject) {
    setProjects((prev) => {
      const i = prev.findIndex((x) => x.id === p.id);
      if (i === -1) return [p, ...prev];
      const copy = [...prev];
      copy[i] = p;
      return copy;
    });
  }

  function updateProject(id: string, patch: Partial<ReactorProject>) {
    setProjects((prev) =>
      prev.map((p) => (p.id === id ? { ...p, ...patch } : p))
    );
  }

  async function refreshHealth() {
    setHealthLoading(true);
    try {
      setHealth(await getHealth());
    } finally {
      setHealthLoading(false);
    }
  }
  async function refreshModels() {
    setModelsLoading(true);
    try {
      setModelsStatus(await getModelsStatus());
    } finally {
      setModelsLoading(false);
    }
  }
  async function refreshTasks() {
    setTasksLoading(true);
    try {
      setTasks(await listTasks());
    } finally {
      setTasksLoading(false);
    }
  }

  useEffect(() => {
    refreshHealth();
    refreshModels();
    refreshTasks();
  }, []);

  useEffect(() => {
    function onKey(e: KeyboardEvent) {
      if (e.key === "Escape") setSidebarOpen(false);
      if (e.key === "F1") {
        e.preventDefault();
        setActiveView("dashboard");
        setSidebarOpen(false);
      }
      if (e.key === "F2") {
        e.preventDefault();
        setActiveView("pipeline");
        setSidebarOpen(false);
      }
      if (e.key === "F3") {
        e.preventDefault();
        setActiveView("rag");
        setSidebarOpen(false);
      }
    }
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, []);

  const ollamaOk = health?.ollama === "online" ? true : health ? false : null;
  const dbOk = health?.database?.status === "online" ? true : health ? false : null;

  return (
    <div className="app-root">
      <button
        className="hamburger"
        onClick={() => setSidebarOpen((s) => !s)}
        aria-label="Open menu"
      >
        ☰
      </button>
      {sidebarOpen && <div className="sidebar-overlay" onMouseDown={() => setSidebarOpen(false)} />}
      <aside className={`sidebar ${sidebarOpen ? "open" : ""}`}>
        <div className="logo">
          <span>WOPR</span> / REACTOR
        </div>
        <div>
          <div className="sidebar-section-title">Views</div>
          <div className="sidebar-nav">
            <button
              className={"sidebar-button" + (activeView === "dashboard" ? " active" : "")}
              onClick={() => {
                setActiveView("dashboard");
                setSidebarOpen(false);
              }}
            >
              <span>Dashboard</span>
              <span className="key">[F1]</span>
            </button>
            <button
              className={"sidebar-button" + (activeView === "pipeline" ? " active" : "")}
              onClick={() => {
                setActiveView("pipeline");
                setSidebarOpen(false);
              }}
            >
              <span>Pipeline & Editor</span>
              <span className="key">[F2]</span>
            </button>
            <button
              className={"sidebar-button" + (activeView === "rag" ? " active" : "")}
              onClick={() => {
                setActiveView("rag");
                setSidebarOpen(false);
              }}
            >
              <span>RAG / Docs</span>
              <span className="key">[F3]</span>
            </button>
          </div>
        </div>
        <div>
          <div className="sidebar-section-title">Models</div>
          <div className="chip-list">
            {modelsLoading ? (
              <span className="muted">loading…</span>
            ) : (modelsStatus?.configured_models || []).length ? (
              (modelsStatus?.configured_models || []).map((m: string) => (
                <span key={m} className="chip">
                  {m}
                </span>
              ))
            ) : (
              <span className="muted">unavailable</span>
            )}
          </div>
        </div>
        <div>
          <div className="sidebar-section-title">Active Project</div>
          <div className="active-project-card">
            <div className="mono">{activeProject?.name || "—"}</div>
            <div className="muted small">{activeProject ? repoDisplay(activeProject) : "Select in Pipeline"}</div>
          </div>
        </div>
        <div className="sidebar-footer">
          <div>NodeZ3r0 · Spec Kit</div>
          <div style={{ fontSize: 10, opacity: 0.7 }}>
            API: {"/api"}
          </div>
        </div>
      </aside>
      <main className="main-shell">
        <div className="top-bar">
          <div className="top-bar-left">
            <div className="top-bar-title">
              <div>ReactorAI™</div>
              <div style={{ fontSize: 10, opacity: 0.8 }}>
                by NodeZ3r0 @ Blackout Labs
              </div>
            </div>
            <div className="top-bar-subtitle">Multi-model pipeline · RAG · Repo operations</div>
          </div>
          <div className="top-bar-right">
            <div className="env-pill">env: NODEZ3R0 / Rig</div>
            <div className="health-chip">
              <span className={"health-dot " + pillClass(ollamaOk && dbOk ? true : ollamaOk === null ? null : false)} />
              <span>
                {healthLoading
                  ? "Checking health..."
                  : health
                  ? `Ollama: ${health.ollama} · DB: ${health.database.status}`
                  : "No health data"}
              </span>
            </div>
            <Button onClick={refreshHealth} variant="ghost">
              Health
            </Button>
          </div>
        </div>
        {activeView === "dashboard" && (
          <DashboardView
            health={health}
            modelsStatus={modelsStatus}
            tasks={tasks}
            onRefreshHealth={refreshHealth}
            onRefreshModels={refreshModels}
            onRefreshTasks={refreshTasks}
          />
        )}
        {activeView === "pipeline" && (
          <PipelineView
            projects={projects}
            activeProjectId={activeProjectId}
            setActiveProjectId={(id) => setActiveProjectId(id)}
            upsertProject={upsertProject}
            updateProject={updateProject}
          />
        )}
        {activeView === "rag" && <RagView activeProject={activeProject} />}
      </main>
    </div>
  );
}
